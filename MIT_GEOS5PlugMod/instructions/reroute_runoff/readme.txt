GEOS routes the runoff to the ocean based on GEOS ocean mask. 
The runoff rerouting script output a binary file that contains 
information to GEOS where to reroute the runoff whenever the 
runoff is directed to a land point in MITgcm. 
The current implemetation is valid only for llc grids with cubed faces (nx=ny).

# For running the reroute file one needs:
# 1. mask file ( this is generated by running a short experiment with MASKO in HISTORY.rc, see below)
# 2. tile file
# 3. routing table
# 4. data.exch2

#Create working directory
mkdir $WorkDir
# cd and copy the files to working directory
cd $WorkDir

# this extracts the blanklist to a file blanklist.txt
sed -n -e '/blankList.*=.*/,$p' data.exch2 | sed 's/blankList//g' | tr -d = | tr -d "\n" | tr -d " " | tr -d "&" | sed 's/.$//' > blanklist.txt

# inside reroute.py link the files:
#   gfile - the mask file
#   runoff_table - the routing table
#   tfile - the tile file
# and change nps to the number of processors

# compile reroute3.f90
# there are two options here reroute3.f90 and reroute.f90. The first is 
# faster and less accurate (based on lat/lon and discontinuous in longitude) which is relevant for HiRes
# the second is accurate based on geodesic distance
# These modules may be needed
# module load other/comp/gcc-5.3-sp3
# module load other/SSSO_Ana-PyD/SApd_4.2.0_py2.7_gcc-5.3-sp3

f2py -c -m reroute3 reroute3.f90

or

f2py -c -m reroute reroute.f90

# run the reroute script:

python reroute.py

##################################################################################################

To output mask from coupled run add this collection to HISTORY.rc (no regriding):

  mit_mask.template:  '%y4%m2%d2_%h2%n2z.nc4',
  mit_mask.archive:   '%c/Y%y4',
  mit_mask.format: 'CFIO',
  mit_mask.frequency: 010000,
  mit_mask.fields: 'MASKO' , 'OCEAN' ,
       ::

Add also mit_mask to the list of collections (COLLECTIONS)

